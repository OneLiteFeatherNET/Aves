include:
  - project: onelitefeather/ci-template
    ref: Better-Pipelines
    file: base.yaml


deploy:
  stage: deploy
  script:
    - gradle publish
  cache:
    key: "$CI_COMMIT_REF_NAME"
    policy: push
    paths:
      - build
      - .gradle
  artifacts:
    expire_in: 1 week
    name: "jar-files"
    paths:
      - build/libs/*.jar
  only:
    - main
    - master
    - test
    - develop


### TESTING
# Gradle general settings
.settings: &settings
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.internal.launcher.welcomeMessageEnabled=false"
  CACHE_COMPRESSION_LEVEL: "fastest"
  ARTIFACT_COMPRESSION_LEVEL: "fast"
  FF_USE_FASTZIP: 1
  TRANSFER_METER_FREQUENCY: "1s"
  KUBERNETES_CPU_REQUEST: "4"
  KUBERNETES_CPU_LIMIT: "4"
  KUBERNETES_MEMORY_REQUEST: "4Gi"
  KUBERNETES_MEMORY_LIMIT: "8Gi"
  KUBERNETES_EPHEMERAL_STORAGE_REQUEST: "2Gi"
  KUBERNETES_EPHEMERAL_STORAGE_LIMIT: "5Gi"

  KUBERNETES_HELPER_CPU_REQUEST: "4"
  KUBERNETES_HELPER_CPU_LIMIT: "4"
  KUBERNETES_HELPER_MEMORY_REQUEST: "4Gi"
  KUBERNETES_HELPER_MEMORY_LIMIT: "8Gi"
  KUBERNETES_HELPER_EPHEMERAL_STORAGE_REQUEST: "2Gi"
  KUBERNETES_HELPER_EPHEMERAL_STORAGE_LIMIT: "5Gi"

  KUBERNETES_SERVICE_CPU_REQUEST: "4"
  KUBERNETES_SERVICE_CPU_LIMIT: "4"
  KUBERNETES_SERVICE_MEMORY_REQUEST: "2Gi"
  KUBERNETES_SERVICE_MEMORY_LIMIT: "4Gi"
  KUBERNETES_SERVICE_EPHEMERAL_STORAGE_REQUEST: "512Mi"
  KUBERNETES_SERVICE_EPHEMERAL_STORAGE_LIMIT: "1Gi"

.gradle-cache: &gradle-cache
  key: $CI_COMMIT_REF_SLUG
  paths:
  - "$CI_PROJECT_DIR/.gradle"
  policy: pull

.gradle-project: &gradle-project
  key: $CI_COMMIT_REF_SLUG
  paths:
    - build
  policy: pull-push

.sonar: &sonar
  key: "$CI_COMMIT_REF_SLUG-sonar"
  paths:
    -  $CI_PROJECT_DIR/.sonar/cache
  policy: pull-push

test:
  image: repo.htl-md.schule:5003/gradle:7.6.0-jdk17-alpine
  stage: test
  variables:
    SONAR_USER_HOME: "$CI_PROJECT_DIR/.sonar"  # Defines the location of the analysis task cache
    GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task
    <<: *settings
  dependencies: []
  cache:
    - <<: *gradle-cache
    - <<: *gradle-project
    - <<: *sonar
  script: gradle --build-cache sonar -Dsonar.host.url=$SONAR_HOST_URL -Dsonar.login=$SONAR_TOKEN -Dsonar.gitlab.project_id=$CI_PROJECT_ID -Dsonar.gitlab.commit_sha=$CI_COMMIT_SHA -Dsonar.gitlab.ref_name=$CI_COMMIT_REF_NAME -Dsonar.branch.name=$CI_COMMIT_REF_NAME -Dsonar.qualitygate.wait=true 
  allow_failure: false
  only:
    - master
    - develop
    - main
    - test


sonarqube-check-mr:
  image: repo.htl-md.schule:5003/gradle:7.6.0-jdk17-alpine
  stage: test
  variables:
    SONAR_USER_HOME: "$CI_PROJECT_DIR/.sonar"  # Defines the location of the analysis task cache
    GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task
    <<: *settings
  dependencies: []
  cache:
    - <<: *gradle-cache
    - <<: *gradle-project
    - <<: *sonar
  script: 
    - echo $CI_PROJECT_ID
    - gradle sonar -Dsonar.host.url=$SONAR_HOST_URL -Dsonar.login=$SONAR_TOKEN -Dsonar.gitlab.project_id=$CI_PROJECT_ID -Dsonar.gitlab.commit_sha=$CI_COMMIT_SHA -Dsonar.gitlab.ref_name=$CI_COMMIT_REF_NAME -Dsonar.qualitygate.wait=true -Dsonar.gitlab.merge_request_discussion=true -Dsonar.gitlab.ci_merge_request_iid=$CI_MERGE_REQUEST_IID -Dsonar.pullrequest.branch=$CI_COMMIT_REF_NAME -Dsonar.pullrequest.key=$CI_MERGE_REQUEST_IID -Dsonar.pullrequest.base=$CI_EXTERNAL_PULL_REQUEST_TARGET_BRANCH_NAME -Dsonar.gitlab.json_mode=CODECLIMATE -Dsonar.gitlab.failure_notification_mode=commit-status 
  only:
    - merge_requests
  artifacts:
    expire_in: 1 day
    paths:
      - gl-code-quality-report.json

codequality:
  stage: quality
  variables:
    GIT_STRATEGY: none
  script:
    - echo ok
  artifacts:
    paths:
      - gl-code-quality-report.json
